#!/bin/bash

# Setup-Skript für ExpanderPiSetup
# Einbinden der Helper-Ressourcen
source "/data/SetupHelper/HelperResources/IncludeHelpers"

# Standardaktionen aktivieren
standardPromptAndActions='yes'

# Pfaddefinitionen
configFile="/etc/venus/dbus-adc.conf"
sourceConfigFile="/data/ExpanderPiSetup/FileSets/configs/dbus-adc.conf"
backupConfigFile="${configFile}.orig"
sourceFileDir="/data/ExpanderPiSetup/FileSets"
overlays=("i2c-rtc.dtbo" "ds1307-rtc.dtbo" "mcp3208.dtbo")
overlayDir="/u-boot/overlays"
configTxt="/u-boot/config.txt"
configTxtBackup="/u-boot/config.txt.orig"
requiredModules=("kernel-module-rtc-ds1307" "kernel-module-mcp320x")
rcLocalFile="/data/rc.local"
rcLocalBackup="/data/rc.local.orig"
rcLocalContent="echo ds1307 0x68 > /sys/class/i2c-adapter/i2c-1/new_device\nhwclock -s"

# Funktionen definieren
checkCompatibility() {
    if [ ! -f /etc/venus/machine ]; then
        logMessage "Kann den Venus-Gerätetyp nicht bestimmen - Skript wird beendet."
        exit 1
    fi

    machine=$(cat /etc/venus/machine)
    if [[ "$machine" != "raspberrypi2" && "$machine" != "raspberrypi4" ]]; then
        logMessage "$machine wird nicht unterstützt - Skript wird beendet."
        exit 1
    fi
}

backupOriginals() {
    backupFile "$configFile" "$backupConfigFile"
    backupFile "$configTxt" "$configTxtBackup"
    backupFile "$rcLocalFile" "$rcLocalBackup"
}

installConfig() {
    logMessage "Installiere dbus-adc.conf..."
    if [ -f "$sourceConfigFile" ]; then
        cp "$sourceConfigFile" "$configFile"
        logMessage "dbus-adc.conf erfolgreich installiert."
    else
        logMessage "Fehler: dbus-adc.conf Quelle nicht gefunden."
    fi
    
    # Füge neue Einträge unterhalb von [all] in config.txt ein
    if ! grep -q "dtoverlay=i2c-rtc,ds1307-rtc" "$configTxt"; then
        echo "dtoverlay=i2c-rtc,ds1307-rtc" >> "$configTxt"
    fi
    if ! grep -q "dtoverlay=mcp3208:spi0-0-present" "$configTxt"; then
        echo "dtoverlay=mcp3208:spi0-0-present" >> "$configTxt"
    fi

    logMessage "$configTxt aktualisiert."
    rebootNeeded=true
}

checkAndRestoreOverlays() {
    for overlay in "${overlays[@]}"; do
        if [ ! -f "$overlayDir/$overlay" ]; then
            logMessage "Overlay $overlay fehlt. Wiederherstellung aus $sourceFileDir/overlays..."
            if [ -f "$sourceFileDir/overlays/$overlay" ]; then
                cp "$sourceFileDir/overlays/$overlay" "$overlayDir/"
                logMessage "Overlay $overlay erfolgreich wiederhergestellt."
                rebootNeeded=true
            else
                logMessage "Fehler: Quelle für Overlay $overlay nicht gefunden."
            fi
        fi
    done
}

checkAndInstallKernelModules() {
    for module in "${requiredModules[@]}"; do
        if ! opkg list-installed | grep -q "$module"; then
            logMessage "Installiere $module..."
            opkg update && opkg install "$module" && logMessage "$module installiert."
            rebootNeeded=true
        fi
    done
}

setupRcLocal() {
    if [ -f "$rcLocalFile" ]; then
        if ! grep -q "$rcLocalContent" "$rcLocalFile"; then
            echo -e "\n$rcLocalContent" >> "$rcLocalFile"
        else
            logMessage "Einträge bereits in $rcLocalFile vorhanden."
        fi
    else
        logMessage "Erstelle $rcLocalFile..."
        echo -e "$rcLocalContent" > "$rcLocalFile"
    fi
    chmod +x "$rcLocalFile"
}

uninstall() {
    # Entferne Einträge aus der config.txt
    sed -i '/dtoverlay=i2c-rtc,ds1307-rtc/d' "$configTxt"
    sed -i '/dtoverlay=mcp3208:spi0-0-present/d' "$configTxt"

    # Entferne Einträge aus der rc.local
    sed -i '/ds1307 0x68 > \/sys\/class\/i2c-adapter\/i2c-1\/new_device/d' "$rcLocalFile"
    sed -i '/hwclock -s/d' "$rcLocalFile"

    # Entferne Dateien aus dem /u-boot/overlays-Ordner
    for overlay in "${overlays[@]}"; do
        [ -f "$overlayDir/$overlay" ] && rm -f "$overlayDir/$overlay"
    done

    # Entferne die dbus-adc.conf aus /etc/venus
    [ -f "$configFile" ] && rm -f "$configFile"

    logMessage "Deinstallation abgeschlossen."
    rebootNeeded=true
}

# Hauptlogik basierend auf der Aktion
case "$scriptAction" in
    INSTALL)
        backupOriginals
        logMessage "Beginne mit der Installation..."
        checkCompatibility
        installConfig
        checkAndRestoreOverlays
        checkAndInstallKernelModules
        setupRcLocal
        ;;
    UNINSTALL)
        uninstall
        ;;
    *)
        logMessage "Keine spezifische Aktion angegeben. Führe Standardinstallation durch..."
        backupOriginals
        checkCompatibility
        installConfig
        checkAndRestoreOverlays
        checkAndInstallKernelModules
        setupRcLocal
        ;;
esac

# Skriptende
logMessage "Skriptausführung abgeschlossen."
