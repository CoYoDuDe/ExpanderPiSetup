#!/bin/bash

# Einbinden der SetupHelper CommonResources
source "/data/SetupHelper/CommonResources"

# Pfaddefinitionen
configFile="/etc/venus/dbus-adc.conf"
sourceFileDir="/data/ExpanderPiSetup/FileSets"
overlays=("i2c-rtc.dtbo" "ds1307-rtc.dtbo" "mcp3208.dtbo")
overlayDir="/u-boot/overlays"
configTxt="/u-boot/config.txt"
rcLocalFile="/data/rc.local"
rcLocalContent=("echo ds1307 0x68 > /sys/class/i2c-adapter/i2c-1/new_device" "hwclock -s")

# Überprüfen der Kompatibilität und Vorbereitung der Umgebung
checkCompatibility
backupOriginals

# Installationsroutine
install() {
    getFileLists "$sourceFileDir"
    for file in "${fileListAll[@]}"; do
        updateActiveFile "$sourceFileDir/$file" "/path/to/destination/$file"
    done

    updateConfigAndOverlays
    executeAndAddToRcLocalEntries
}

# Funktion zum Hinzufügen von Einträgen zu rc.local
addToRcLocal() {
    if ! grep -qF -- "${1}" "${rcLocalFile}"; then
        echo "${1}" >> "${rcLocalFile}"
    fi
}

# Funktion zum Ausführen und Hinzufügen der rc.local Einträge
executeAndAddToRcLocalEntries() {
    for entry in "${rcLocalContent[@]}"; do
        eval $entry  # Führt den Befehl sofort aus
        addToRcLocal "$entry"  # Fügt den Befehl zu rc.local hinzu, falls nicht vorhanden
    done
}

# Aktualisieren der config.txt und Überprüfen der Overlays
updateConfigAndOverlays() {
    updateConfigEntry "dtoverlay=i2c-rtc,ds1307-rtc" "$configTxt"
    updateConfigEntry "dtoverlay=mcp3208:spi0-0-present" "$configTxt"

    for overlay in "${overlays[@]}"; do
        if [ ! -f "$overlayDir/$overlay" ]; then
            cp "$sourceFileDir/$overlay" "$overlayDir/$overlay"
            updateRestartFlags "$overlayDir/$overlay"
        fi
    done
}

# Deinstallationsroutine
uninstall() {
    getFileLists "$sourceFileDir"
    for file in "${fileListAll[@]}"; do
        restoreActiveFile "/path/to/destination/$file"
    done

    removeRcLocalEntries
}

# Entfernen spezifischer Einträge aus rc.local
removeRcLocalEntries() {
    for content in "${rcLocalContent[@]}"; do
        sed -i "/$content/d" "$rcLocalFile"
    done
}

# Hauptlogik
if [ "$scriptAction" == 'INSTALL' ]; then
    install
elif [ "$scriptAction" == 'UNINSTALL' ]; then
    uninstall
fi

# GUI-Neustart oder Systemneustart, falls erforderlich
manageRestart

# Abschluss der Skriptausführung
endScript
