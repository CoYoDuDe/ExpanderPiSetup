#!/bin/bash

# Einbinden der SetupHelper CommonResources
source "/data/SetupHelper/CommonResources"

# Pfaddefinitionen
configFile="/etc/venus/dbus-adc.conf"
sourceFileDir="/data/ExpanderPiSetup/FileSets"
overlays=("i2c-rtc.dtbo" "ds1307-rtc.dtbo" "mcp3208.dtbo")
overlayDir="/u-boot/overlays"
configTxt="/u-boot/config.txt"
rcLocalFile="/data/rc.local"
rcLocalContent=("echo ds1307 0x68 > /sys/class/i2c-adapter/i2c-1/new_device" "hwclock -s")

# Installationsroutine
install() {
    getFileLists "$sourceFileDir"  # Lädt Dateilisten für die Installation
    for file in "${fileListAll[@]}"; do
        updateActiveFile "$sourceFileDir/$file" "/path/to/destination/$file"
    done

    updateConfigAndOverlays
}

# Aktualisieren der config.txt und Überprüfen der Overlays
updateConfigAndOverlays() {
    updateConfigEntry "dtoverlay=i2c-rtc,ds1307-rtc" "$configTxt"
    updateConfigEntry "dtoverlay=mcp3208:spi0-0-present" "$configTxt"

    for overlay in "${overlays[@]}"; do
        if [ ! -f "$overlayDir/$overlay" ]; then
            cp "$sourceFileDir/$overlay" "$overlayDir/$overlay"
            updateRestartFlags "$overlayDir/$overlay"
        fi
    done
}

# Deinstallationsroutine
uninstall() {
    getFileLists "$sourceFileDir"  # Lädt Dateilisten für die Deinstallation
    for file in "${fileListAll[@]}"; do
        restoreActiveFile "/path/to/destination/$file"
    done

    removeRcLocalEntries
}

# Entfernen spezifischer Einträge aus rc.local
removeRcLocalEntries() {
    for content in "${rcLocalContent[@]}"; do
        sed -i "/$content/d" "$rcLocalFile"
    done
}

# Hauptlogik
if [ "$scriptAction" == 'INSTALL' ]; then
    install
elif [ "$scriptAction" == 'UNINSTALL' ]; then
    uninstall
fi

# GUI-Neustart oder Systemneustart, falls erforderlich
if $restartGui; then
    restartGuiService
fi

if $rebootNeeded; then
    if yesNoPrompt "Systemneustart jetzt durchführen? (y/n): "; then
        reboot
    else
        logMessage "Ein Neustart ist erforderlich, um die Installation abzuschließen."
    fi
fi

# Abschluss der Skriptausführung
endScript 'INSTALL_FILES' 'INSTALL_SERVICES'
